/*
 * Copyright (c) 2016 SugarCRM Inc. Licensed by SugarCRM under the Apache 2.0 license.
 */
(function(){var sucrose=window.sucrose||{};sucrose.version="0.0.1a";sucrose.dev=false;window.sucrose=sucrose;sucrose.tooltip={};sucrose.utils={};sucrose.models={};sucrose.charts={};sucrose.graphs=[];sucrose.logs={};sucrose.dispatch=d3.dispatch("render_start","render_end");if(sucrose.dev){sucrose.dispatch.on("render_start",function(e){sucrose.logs.startTime=+new Date});sucrose.dispatch.on("render_end",function(e){sucrose.logs.endTime=+new Date;sucrose.logs.totalTime=sucrose.logs.endTime-sucrose.logs.startTime;sucrose.log("total",sucrose.logs.totalTime)})}sucrose.log=function(){if(sucrose.dev&&console.log&&console.log.apply)console.log.apply(console,arguments);else if(sucrose.dev&&console.log&&Function.prototype.bind){var log=Function.prototype.bind.call(console.log,console);log.apply(console,arguments)}return arguments[arguments.length-1]};sucrose.render=function render(step){step=step||1;sucrose.render.active=true;sucrose.dispatch.render_start();setTimeout(function(){var chart,graph;for(var i=0;i<step&&(graph=sucrose.render.queue[i]);i++){chart=graph.generate();if(typeof graph.callback==typeof Function)graph.callback(chart);sucrose.graphs.push(chart)}sucrose.render.queue.splice(0,i);if(sucrose.render.queue.length)setTimeout(arguments.callee,0);else{sucrose.render.active=false;sucrose.dispatch.render_end()}},0)};sucrose.render.active=false;sucrose.render.queue=[];sucrose.addGraph=function(obj){if(typeof arguments[0]===typeof Function)obj={generate:arguments[0],callback:arguments[1]};sucrose.render.queue.push(obj);if(!sucrose.render.active)sucrose.render()};sucrose.identity=function(d){return d};sucrose.strip=function(s){return s.replace(/(\s|&)/g,"")};function daysInMonth(month,year){return new Date(year,month+1,0).getDate()}function d3_time_range(floor,step,number){return function(t0,t1,dt){var time=floor(t0),times=[];if(time<t0)step(time);if(dt>1){while(time<t1){var date=new Date(+time);if(number(date)%dt===0)times.push(date);step(time)}}else{while(time<t1){times.push(new Date(+time));step(time)}}return times}}d3.time.monthEnd=function(date){return new Date(date.getFullYear(),date.getMonth(),0)};d3.time.monthEnds=d3_time_range(d3.time.monthEnd,function(date){date.setUTCDate(date.getUTCDate()+1);date.setDate(daysInMonth(date.getMonth()+1,date.getFullYear()))},function(date){return date.getMonth()});d3.svg.axisStatic=function(){var scale=d3.scale.linear(),orient=d3_svg_axisDefaultOrient,tickMajorSize=6,tickMinorSize=6,tickEndSize=6,tickPadding=3,tickArguments_=[10],tickValues=null,tickFormat_,tickSubdivide=0;var d3_svg_axisDefaultOrient="bottom",d3_svg_axisOrients={top:1,right:1,bottom:1,left:1};function d3_scaleExtent(domain){var start=domain[0],stop=domain[domain.length-1];return start<stop?[start,stop]:[stop,start]}function d3_scaleRange(scale){return scale.rangeExtent?scale.rangeExtent():d3_scaleExtent(scale.range())}function d3_svg_axisX(selection,x){selection.attr("transform",function(d){return"translate("+x(d)+",0)"})}function d3_svg_axisY(selection,y){selection.attr("transform",function(d){return"translate(0,"+y(d)+")"})}function d3_svg_axisSubdivide(scale,ticks,m){subticks=[];if(m&&ticks.length>1){var extent=d3_scaleExtent(scale.domain()),subticks,i=-1,n=ticks.length,d=(ticks[1]-ticks[0])/++m,j,v;while(++i<n){for(j=m;--j>0;){if((v=+ticks[i]-j*d)>=extent[0]){subticks.push(v)}}}for(--i,j=0;++j<m&&(v=+ticks[i]+j*d)<extent[1];){subticks.push(v)}}return subticks}function axis(g){g.each(function(){var g=d3.select(this);var ticks=tickValues==null?scale.ticks?scale.ticks.apply(scale,tickArguments_):scale.domain():tickValues,tickFormat=tickFormat_==null?scale.tickFormat?scale.tickFormat.apply(scale,tickArguments_):String:tickFormat_;var subticks=d3_svg_axisSubdivide(scale,ticks,tickSubdivide),subtick=g.selectAll(".tick.minor").data(subticks,String),subtickEnter=subtick.enter().insert("line",".tick").attr("class","tick minor").style("opacity",1),subtickExit=subtick.exit().remove(),subtickUpdate=subtick.style("opacity",1);var tick=g.selectAll(".tick.major").data(ticks,String),tickEnter=tick.enter().insert("g","path").attr("class","tick major").style("opacity",1),tickExit=tick.exit().remove(),tickUpdate=tick.style("opacity",1),tickTransform;var range=d3_scaleRange(scale),path=g.selectAll(".domain").data([0]),pathUpdate=(path.enter().append("path").attr("class","domain"),path);var scale1=scale.copy();tickEnter.append("line");tickEnter.append("text");var lineEnter=tickEnter.select("line"),lineUpdate=tickUpdate.select("line"),text=tick.select("text").text(tickFormat),textEnter=tickEnter.select("text"),textUpdate=tickUpdate.select("text");switch(orient){case"bottom":{tickTransform=d3_svg_axisX;subtickEnter.attr("y2",tickMinorSize);subtickUpdate.attr("x2",0).attr("y2",tickMinorSize);lineEnter.attr("y2",tickMajorSize);textEnter.attr("y",Math.max(tickMajorSize,0)+tickPadding);lineUpdate.attr("x2",0).attr("y2",tickMajorSize);textUpdate.attr("x",0).attr("y",Math.max(tickMajorSize,0)+tickPadding);text.attr("dy",".71em").style("text-anchor","middle");pathUpdate.attr("d","M"+range[0]+","+tickEndSize+"V0H"+range[1]+"V"+tickEndSize);break}case"top":{tickTransform=d3_svg_axisX;subtickEnter.attr("y2",-tickMinorSize);subtickUpdate.attr("x2",0).attr("y2",-tickMinorSize);lineEnter.attr("y2",-tickMajorSize);textEnter.attr("y",-(Math.max(tickMajorSize,0)+tickPadding));lineUpdate.attr("x2",0).attr("y2",-tickMajorSize);textUpdate.attr("x",0).attr("y",-(Math.max(tickMajorSize,0)+tickPadding));text.attr("dy","0em").style("text-anchor","middle");pathUpdate.attr("d","M"+range[0]+","+-tickEndSize+"V0H"+range[1]+"V"+-tickEndSize);break}case"left":{tickTransform=d3_svg_axisY;subtickEnter.attr("x2",-tickMinorSize);subtickUpdate.attr("x2",-tickMinorSize).attr("y2",0);lineEnter.attr("x2",-tickMajorSize);textEnter.attr("x",-(Math.max(tickMajorSize,0)+tickPadding));lineUpdate.attr("x2",-tickMajorSize).attr("y2",0);textUpdate.attr("x",-(Math.max(tickMajorSize,0)+tickPadding)).attr("y",0);text.attr("dy",".32em").style("text-anchor","end");pathUpdate.attr("d","M"+-tickEndSize+","+range[0]+"H0V"+range[1]+"H"+-tickEndSize);break}case"right":{tickTransform=d3_svg_axisY;subtickEnter.attr("x2",tickMinorSize);subtickUpdate.attr("x2",tickMinorSize).attr("y2",0);lineEnter.attr("x2",tickMajorSize);textEnter.attr("x",Math.max(tickMajorSize,0)+tickPadding);lineUpdate.attr("x2",tickMajorSize).attr("y2",0);textUpdate.attr("x",Math.max(tickMajorSize,0)+tickPadding).attr("y",0);text.attr("dy",".32em").style("text-anchor","start");pathUpdate.attr("d","M"+tickEndSize+","+range[0]+"H0V"+range[1]+"H"+tickEndSize);break}}if(scale.ticks){tickEnter.call(tickTransform,scale1);tickUpdate.call(tickTransform,scale1);tickExit.call(tickTransform,scale1);subtickEnter.call(tickTransform,scale1);subtickUpdate.call(tickTransform,scale1);subtickExit.call(tickTransform,scale1)}else{var dx=scale1.rangeBand()/2,x=function(d){return scale1(d)+dx};tickEnter.call(tickTransform,x);tickUpdate.call(tickTransform,x)}})}axis.scale=function(x){if(!arguments.length)return scale;scale=x;return axis};axis.orient=function(x){if(!arguments.length)return orient;orient=x in d3_svg_axisOrients?x+"":d3_svg_axisDefaultOrient;return axis};axis.ticks=function(){if(!arguments.length)return tickArguments_;tickArguments_=arguments;return axis};axis.tickValues=function(x){if(!arguments.length)return tickValues;tickValues=x;return axis};axis.tickFormat=function(x){if(!arguments.length)return tickFormat_;tickFormat_=x;return axis};axis.tickSize=function(x,y){if(!arguments.length)return tickMajorSize;var n=arguments.length-1;tickMajorSize=+x;tickMinorSize=n>1?+y:tickMajorSize;tickEndSize=n>0?+arguments[n]:tickMajorSize;return axis};axis.tickPadding=function(x){if(!arguments.length)return tickPadding;tickPadding=+x;return axis};axis.tickSubdivide=function(x){if(!arguments.length)return tickSubdivide;tickSubdivide=+x;return axis};return axis};(function(){var sctooltip=window.sucrose.tooltip={};sctooltip.show=function(evt,content,gravity,dist,container,classes){var tooltip=document.createElement("div"),inner=document.createElement("div"),arrow=document.createElement("div");gravity=gravity||"s";dist=dist||5;inner.className="tooltip-inner";arrow.className="tooltip-arrow";inner.innerHTML=content;tooltip.style.left=0;tooltip.style.top=-1e3;tooltip.style.opacity=0;tooltip.className="tooltip xy-tooltip in";tooltip.appendChild(inner);tooltip.appendChild(arrow);container.appendChild(tooltip);sctooltip.position(container,tooltip,evt,gravity,dist);tooltip.style.opacity=1;return tooltip};sctooltip.cleanup=function(){var tooltips=document.getElementsByClassName("tooltip"),purging=[],i=tooltips.length;while(i>0){i-=1;if(tooltips[i].className.indexOf("xy-tooltip")!==-1){purging.push(tooltips[i]);tooltips[i].style.transitionDelay="0 !important";tooltips[i].style.opacity=0;tooltips[i].className="sctooltip-pending-removal out"}}setTimeout(function(){var removeMe;while(purging.length){removeMe=purging.pop();removeMe.parentNode.removeChild(removeMe)}},500)};sctooltip.position=function(container,tooltip,evt,gravity,dist){gravity=gravity||"s";dist=dist||5;var pos=[typeof evt.layerX==="undefined"?evt.offsetX:evt.layerX,typeof evt.layerY==="undefined"?evt.offsetY:evt.layerY];var tooltipWidth=parseInt(tooltip.offsetWidth,10),tooltipHeight=parseInt(tooltip.offsetHeight,10),containerWidth=container.clientWidth,containerHeight=container.clientHeight,containerLeft=container.scrollLeft,containerTop=container.scrollTop,class_name=tooltip.className.replace(/ top| right| bottom| left/g,""),left,top;function alignCenter(){var left=pos[0]-tooltipWidth/2;if(left<containerLeft)left=containerLeft;if(left+tooltipWidth>containerWidth)left=containerWidth-tooltipWidth;return left}function alignMiddle(){var top=pos[1]-tooltipHeight/2;if(top<containerTop)top=containerTop;if(top+tooltipHeight>containerTop+containerHeight)top=containerTop-tooltipHeight;return top}function arrowLeft(left){var marginLeft=pos[0]-tooltipWidth/2-left-5,arrow=tooltip.getElementsByClassName("tooltip-arrow")[0];arrow.style.marginLeft=marginLeft+"px"}function arrowTop(top){var marginTop=pos[1]-tooltipHeight/2-top-5,arrow=tooltip.getElementsByClassName("tooltip-arrow")[0];arrow.style.marginTop=marginTop+"px"}switch(gravity){case"e":top=alignMiddle();left=pos[0]-tooltipWidth-dist;arrowTop(top);if(left<containerLeft){left=pos[0]+dist;class_name+=" right"}else{class_name+=" left"}break;case"w":top=alignMiddle();left=pos[0]+dist;arrowTop(top);if(left+tooltipWidth>containerWidth){left=pos[0]-tooltipWidth-dist;class_name+=" left"}else{class_name+=" right"}break;case"n":left=alignCenter();top=pos[1]+dist;arrowLeft(left);if(top+tooltipHeight>containerTop+containerHeight){top=pos[1]-tooltipHeight-dist;class_name+=" top"}else{class_name+=" bottom"}break;case"s":left=alignCenter();top=pos[1]-tooltipHeight-dist;arrowLeft(left);if(containerTop>top){top=pos[1]+dist;class_name+=" bottom"}else{class_name+=" top"}break}tooltip.style.left=left+"px";tooltip.style.top=top+"px";tooltip.className=class_name}})();sucrose.utils.windowSize=function(){var size={width:640,height:480};if(document.body&&document.body.offsetWidth){size.width=document.body.offsetWidth;size.height=document.body.offsetHeight}if(document.compatMode==="CSS1Compat"&&document.documentElement&&document.documentElement.offsetWidth){size.width=document.documentElement.offsetWidth;size.height=document.documentElement.offsetHeight}if(window.innerWidth&&window.innerHeight){size.width=window.innerWidth;size.height=window.innerHeight}return size};sucrose.utils.windowResize=function(fun){if(window.attachEvent){window.attachEvent("onresize",fun)}else if(window.addEventListener){window.addEventListener("resize",fun,true)}else{}};sucrose.utils.windowUnResize=function(fun){if(window.detachEvent){window.detachEvent("onresize",fun)}else if(window.removeEventListener){window.removeEventListener("resize",fun,true)}else{}};sucrose.utils.resizeOnPrint=function(fn){if(window.matchMedia){var mediaQueryList=window.matchMedia("print");mediaQueryList.addListener(function(mql){if(mql.matches){fn()}})}else if(window.attachEvent){window.attachEvent("onbeforeprint",fn)}else{window.onbeforeprint=fn}};sucrose.utils.unResizeOnPrint=function(fn){if(window.matchMedia){var mediaQueryList=window.matchMedia("print");mediaQueryList.removeListener(function(mql){if(mql.matches){fn()}})}else if(window.detachEvent){window.detachEvent("onbeforeprint",fn)}else{window.onbeforeprint=null}};sucrose.utils.getColor=function(color){if(!arguments.length){return sucrose.utils.defaultColor()}if(Object.prototype.toString.call(color)==="[object Array]"){return function(d,i){return d.color||color[i%color.length]}}else{return color}};sucrose.utils.defaultColor=function(){var colors=d3.scale.category20().range();return function(d,i){return d.color||colors[i%colors.length]}};sucrose.utils.customTheme=function(dictionary,getKey,defaultColors){getKey=getKey||function(series){return series.key};defaultColors=defaultColors||d3.scale.category20().range();var defIndex=defaultColors.length;return function(series,index){var key=getKey(series);if(!defIndex)defIndex=defaultColors.length;if(typeof dictionary[key]!=="undefined"){return typeof dictionary[key]==="function"?dictionary[key]():dictionary[key]}else{return defaultColors[--defIndex]}}};sucrose.utils.pjax=function(links,content){d3.selectAll(links).on("click",function(){history.pushState(this.href,this.textContent,this.href);load(this.href);d3.event.preventDefault()});function load(href){d3.html(href,function(fragment){var target=d3.select(content).node();target.parentNode.replaceChild(d3.select(fragment).select(content).node(),target);sucrose.utils.pjax(links,content)})}d3.select(window).on("popstate",function(){if(d3.event.state){load(d3.event.state)}})};sucrose.utils.NaNtoZero=function(n){if(typeof n!=="number"||isNaN(n)||n===null||n===Infinity)return 0;return n};sucrose.utils.optionsFunc=function(args){if(args){d3.map(args).forEach(function(key,value){if(typeof this[key]==="function"){this[key](value)}}.bind(this))}return this};sucrose.utils.colorLinearGradient=function(d,i,p,c,defs){var id="lg_gradient_"+i,grad=defs.select("#"+id);if(grad.empty()){if(p.position==="middle"){sucrose.utils.createLinearGradient(id,p,defs,[{offset:"0%","stop-color":d3.rgb(c).darker().toString(),"stop-opacity":1},{offset:"20%","stop-color":d3.rgb(c).toString(),"stop-opacity":1},{offset:"50%","stop-color":d3.rgb(c).brighter().toString(),"stop-opacity":1},{offset:"80%","stop-color":d3.rgb(c).toString(),"stop-opacity":1},{offset:"100%","stop-color":d3.rgb(c).darker().toString(),"stop-opacity":1}])}else{sucrose.utils.createLinearGradient(id,p,defs,[{offset:"0%","stop-color":d3.rgb(c).darker().toString(),"stop-opacity":1},{offset:"50%","stop-color":d3.rgb(c).toString(),"stop-opacity":1},{offset:"100%","stop-color":d3.rgb(c).brighter().toString(),"stop-opacity":1}])}}return"url(#"+id+")"};sucrose.utils.createLinearGradient=function(id,params,defs,stops){var x2=params.orientation==="horizontal"?"0%":"100%",y2=params.orientation==="horizontal"?"100%":"0%",grad=defs.append("linearGradient").attr("id",id).attr("x1","0%").attr("y1","0%").attr("x2",x2).attr("y2",y2).attr("spreadMethod","pad");for(var i=0;i<stops.length;i+=1){var attrs=stops[i],stop=grad.append("stop");for(var a in attrs){if(attrs.hasOwnProperty(a)){stop.attr(a,attrs[a])}}}};sucrose.utils.colorRadialGradient=function(d,i,p,c,defs){var id="rg_gradient_"+i,grad=defs.select("#"+id);if(grad.empty()){sucrose.utils.createRadialGradient(id,p,defs,[{offset:p.s,"stop-color":d3.rgb(c).brighter().toString(),"stop-opacity":1},{offset:"100%","stop-color":d3.rgb(c).darker().toString(),"stop-opacity":1}])}return"url(#"+id+")"};sucrose.utils.createRadialGradient=function(id,params,defs,stops){var grad=defs.append("radialGradient").attr("id",id).attr("r",params.r).attr("cx",params.x).attr("cy",params.y).attr("gradientUnits",params.u).attr("spreadMethod","pad");for(var i=0;i<stops.length;i+=1){var attrs=stops[i],stop=grad.append("stop");for(var a in attrs){if(attrs.hasOwnProperty(a)){stop.attr(a,attrs[a])}}}};sucrose.utils.getAbsoluteXY=function(element){var viewportElement=document.documentElement,box=element.getBoundingClientRect(),scrollLeft=viewportElement.scrollLeft+document.body.scrollLeft,scrollTop=viewportElement.scrollTop+document.body.scrollTop,x=box.left+scrollLeft,y=box.top+scrollTop;return{left:x,top:y}};sucrose.utils.roundedRectangle=function(x,y,width,height,radius){return"M"+x+","+y+"h"+(width-radius*2)+"a"+radius+","+radius+" 0 0 1 "+radius+","+radius+"v"+(height-2-radius*2)+"a"+radius+","+radius+" 0 0 1 "+-radius+","+radius+"h"+(radius*2-width)+"a"+-radius+","+radius+" 0 0 1 "+-radius+","+-radius+"v"+(-height+radius*2+2)+"a"+radius+","+radius+" 0 0 1 "+radius+","+-radius+"z"};sucrose.utils.dropShadow=function(id,defs,options){var opt=options||{},h=opt.height||"130%",o=opt.offset||2,b=opt.blur||1;if(defs.select("#"+id).empty()){var filter=defs.append("filter").attr("id",id).attr("height",h);var offset=filter.append("feOffset").attr("in","SourceGraphic").attr("result","offsetBlur").attr("dx",o).attr("dy",o);var color=filter.append("feColorMatrix").attr("in","offsetBlur").attr("result","matrixOut").attr("type","matrix").attr("values","1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 1 0");var blur=filter.append("feGaussianBlur").attr("in","matrixOut").attr("result","blurOut").attr("stdDeviation",b);var merge=filter.append("feMerge");merge.append("feMergeNode");merge.append("feMergeNode").attr("in","SourceGraphic")}return"url(#"+id+")"};sucrose.utils.stringSetLengths=function(_data,_container,_format,classes,styles){var lengths=[],txt=_container.select(".tmp-text-strings").select("text");if(txt.empty()){txt=_container.append("g").attr("class","tmp-text-strings").append("text")}txt.classed(classes,true);txt.style("display","inline");_data.forEach(function(d,i){txt.text(_format(d,i));lengths.push(txt.node().getBoundingClientRect().width)});txt.text("").attr("class","tmp-text-strings").style("display","none");return lengths};sucrose.utils.stringSetThickness=function(_data,_container,_format,classes,styles){var thicknesses=[],txt=_container.select(".tmp-text-strings").select("text");if(txt.empty()){txt=_container.append("g").attr("class","tmp-text-strings").append("text")}txt.classed(classes,true);txt.style("display","inline");_data.forEach(function(d,i){txt.text(_format(d,i));thicknesses.push(txt.node().getBoundingClientRect().height)});txt.text("").attr("class","tmp-text-strings").style("display","none");return thicknesses};sucrose.utils.maxStringSetLength=function(_data,_container,_format){var lengths=sucrose.utils.stringSetLengths(_data,_container,_format);return d3.max(lengths)};sucrose.utils.stringEllipsify=function(_string,_container,_length){var txt=_container.select(".tmp-text-strings").select("text"),str=_string,len=0,ell=0,strLen=0;if(txt.empty()){txt=_container.append("g").attr("class","tmp-text-strings").append("text")}txt.style("display","inline");txt.text("...");ell=txt.node().getBoundingClientRect().width;txt.text(str);len=txt.node().getBoundingClientRect().width;strLen=len;while(len>_length&&len>30){str=str.slice(0,-1);txt.text(str);len=txt.node().getBoundingClientRect().width+ell}txt.text("").style("display","none");return str+(strLen>_length?"...":"")};sucrose.utils.getTextBBox=function(text,floats){var bbox=text.node().getBoundingClientRect(),size={width:floats?bbox.width:parseInt(bbox.width,10),height:floats?bbox.height:parseInt(bbox.height,10)};return size};sucrose.utils.getTextContrast=function(c,i,callback){var back=c,backLab=d3.lab(back),backLumen=backLab.l,textLumen=backLumen>60?backLab.darker(4+(backLumen-75)/25).l:backLab.brighter(4+(18-backLumen)/25).l,textLab=d3.lab(textLumen,0,0),text=textLab.toString();if(callback){callback(backLab,textLab)}return text};sucrose.utils.isRTLChar=function(c){var rtlChars_="֑-߿יִ-﷿ﹰ-ﻼ",rtlCharReg_=new RegExp("["+rtlChars_+"]");return rtlCharReg_.test(c)};sucrose.utils.polarToCartesian=function(centerX,centerY,radius,angleInDegrees){var angleInRadians=sucrose.utils.angleToRadians(angleInDegrees);var x=centerX+radius*Math.cos(angleInRadians);var y=centerY+radius*Math.sin(angleInRadians);return[x,y]};sucrose.utils.angleToRadians=function(angleInDegrees){return angleInDegrees*Math.PI/180};sucrose.utils.angleToDegrees=function(angleInRadians){return angleInRadians*180/Math.PI};sucrose.utils.isValidDate=function(d){if(!d){return false}var testDate=new Date(d);return testDate instanceof Date&&!isNaN(testDate.valueOf())};sucrose.utils.createTexture=function(defs,id,x,y){var texture="#sc-diagonalHatch-"+id,mask="#sc-textureMask-"+id;defs.append("pattern").attr("id","sc-diagonalHatch-"+id).attr("patternUnits","userSpaceOnUse").attr("width",8).attr("height",8).append("path").attr("d","M-1,1 l2,-2 M0,8 l8,-8 M7,9 l1,-1").attr("class","texture-line").attr("stroke","#fff").attr("stroke-linecap","square");defs.append("mask").attr("id","sc-textureMask-"+id).attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").append("rect").attr("x",x||0).attr("y",y||-1).attr("width","100%").attr("height","100%").attr("fill","url("+texture+")");return mask};sucrose.utils.numberFormatSI=function(d,p){if(p===0){return d}p=p||2;if(d<1&&d>-1){return d3.round(d,p)}var si=d3.formatPrefix(d,p);return d3.round(si.scale(d),p)+si.symbol};sucrose.models.axis=function(){var scale=d3.scale.linear(),axisLabelText=null,showMaxMin=true,highlightZero=true,direction="ltr",wrapTicks=false,staggerTicks=false,rotateTicks=30,reduceXTicks=false,rotateYLabel=true,hasRangeBand=false,textAnchor=null,ticks=null,axisLabelDistance=8;var margin={top:0,right:0,bottom:0,left:0},thickness=0;var axis=d3.svg.axisStatic().scale(scale).orient("bottom").tickFormat(function(d){return d});var scale0;function chart(selection){selection.each(function(data){var container=d3.select(this);var scaleCalc=axis.scale().copy();var marginCalc={top:0,right:0,bottom:0,left:0};var extent=getRangeExtent();var scaleWidth=Math.abs(extent[1]-extent[0]);scale0=scale0||axis.scale();var vertical=axis.orient()==="left"||axis.orient()==="right"?true:false,reflect=axis.orient()==="left"||axis.orient()==="top"?-1:1,fmt=axis.tickFormat(),maxLabelWidth=0,maxLabelHeight=0,tickGap=6,tickSpacing=0,labelThickness=0;var tickDimensions=[],tickDimensionsHash={},tickValueArray=[],minTickDimensions={},maxTickDimensions={};thickness=0;if(ticks!==null){axis.ticks(ticks)}else if(vertical){axis.ticks(Math.ceil(scaleWidth/48))}else{axis.ticks(Math.ceil(scaleWidth/100))}if(rotateTicks&&!isFinite(String(rotateTicks))){rotateTicks=30}if(hasRangeBand){showMaxMin=false}if(fmt===null){fmt=scale0.tickFormat()}var wrap=container.selectAll("g.sc-wrap.sc-axis").data([data]),gEnter=wrap.enter().append("g").attr("class","sucrose sc-wrap sc-axis").append("g").attr("class","sc-axis-inner"),g=wrap.select(".sc-axis-inner");g.call(axis);var axisTicks=g.selectAll("g.tick");var dataMaxMin=showMaxMin?d3.extent(scale.domain()):[];var axisMaxMin=g.selectAll("g.sc-axisMaxMin").data(dataMaxMin);var enterMaxMin=axisMaxMin.enter().append("g").attr("class","sc-axisMaxMin");enterMaxMin.append("text").style("opacity",0);enterMaxMin.append("line").style("opacity",0);axisMaxMin.exit().remove();if(showMaxMin){axisMaxMin.select("text").text(function(d,i){var v=fmt(d,i,false);return(""+v).match("NaN")?"":v})}var tickText=g.selectAll("g.tick, g.sc-axisMaxMin").select("text").filter(function(d){return this.getBoundingClientRect().width});tickText.each(function(d,i){tickValueArray.push(d3.select(this).text())});var axisLabelData=!!axisLabelText?[axisLabelText]:[];var axisLabel=wrap.selectAll("text.sc-axislabel").data(axisLabelData);axisLabel.enter().append("text").attr("class","sc-axislabel").text(function(d){return d});axisLabel.exit().remove();var wrapSucceeded=false,staggerSucceeded=false,rotateSucceeded=false;if(vertical){resetTicks();tickText.style("text-anchor",rtlTextAnchor(textAnchor||(isMirrored()?"start":"end")))}else{resetTicks();recalcMargin();if(labelCollision(1)){if(wrapTicks){resetTicks();handleWrap();recalcMargin();handleWrap();if(!labelCollision(1)){wrapSucceeded=true}}if(!wrapSucceeded&&staggerTicks){resetTicks();handleStagger();recalcMargin();handleStagger();if(!labelCollision(2)){staggerSucceeded=true}}if(!wrapSucceeded&&!staggerSucceeded){if(!rotateTicks){rotateTicks=30}resetTicks();handleRotation(rotateTicks);recalcMargin(rotateTicks);handleRotation(rotateTicks);rotateSucceeded=true}}}if(showMaxMin){axisMaxMin.select("line").attr("x1",0).attr("y1",0).attr("y2",vertical?0:(axis.tickSize()-marginCalc.bottom)*reflect).attr("x2",vertical?axis.tickSize()*reflect:0).style("opacity",function(d,i){return isMirrored()?i?0:1:i?1:0});axisTicks.each(function(d,i){var tick=d3.select(this),dim=tickDimensionsHash["key-"+d.toString()],collision=false;if(vertical){collision=dim.bottom>minTickDimensions.top||dim.top<maxTickDimensions.bottom;tick.select("line").style("opacity",1-collision)}else if(rotateSucceeded){collision=false}else if(staggerSucceeded){collision=(dim.left<minTickDimensions.right+tickGap||dim.right>maxTickDimensions.left+tickGap)&&(dim.bottom<minTickDimensions.top||dim.top>maxTickDimensions.bottom)}else{collision=dim.left<minTickDimensions.right+tickGap||dim.right>maxTickDimensions.left+tickGap}tick.select("text").style("opacity",1-collision)})}else{axisTicks.filter(function(d){return scaleCalc(d)===extent[0+isMirrored()]}).classed("zero",highlightZero);axisTicks.select("line").style("opacity",function(d,i){return scaleCalc(d)===extent[0+isMirrored()]?0:1})}if(!!axisLabelText){var axisLabelX=vertical?rotateYLabel?scaleWidth/-2:(thickness+axisLabelDistance)*reflect:scaleWidth/2;var axisLabelY=vertical?rotateYLabel?(thickness+axisLabelDistance)*reflect:scaleWidth/2:(thickness+axisLabelDistance)*reflect;axisLabel.attr("x",axisLabelX).attr("y",axisLabelY).attr("dy",.355+.355*reflect+"em").attr("transform",vertical&&rotateYLabel?"rotate(-90)":"").style("text-anchor",vertical&&!rotateYLabel?rtlTextAnchor("end"):"middle");axisLabel.each(function(d,i){labelThickness+=vertical?parseInt(this.getBoundingClientRect().width/1.3,10):parseInt(this.getBoundingClientRect().height/1.3,10)});thickness+=labelThickness+axisLabelDistance}scale0=scale.copy();margin={top:marginCalc.top,right:marginCalc.right,bottom:marginCalc.bottom,left:marginCalc.left};margin[axis.orient()]=thickness;function getStepInterval(){return scaleCalc.range().length>1?Math.abs(scaleCalc.range()[1]-scaleCalc.range()[0]):0}function getPaddingRatio(){return scaleCalc.range().length>1?Math.max(.25,1-d3.round(scaleCalc.rangeBand()/getStepInterval(),2)):0}function getRangeExtent(){return typeof scaleCalc.rangeExtent==="function"?scaleCalc.rangeExtent():scaleCalc.range()}function getBarWidth(){return hasRangeBand?scaleCalc.rangeBand():0}function getOuterPadding(){return hasRangeBand?scaleCalc.range()[0]:0}function getOuterPaddingRatio(){return getOuterPadding()/getTickSpacing()}function getTickSpacing(){var tickSpacing=0,tickArray;if(hasRangeBand){tickSpacing=scaleCalc.range().length>1?Math.abs(scaleCalc.range()[1]-scaleCalc.range()[0]):d3.max(getRangeExtent())/2}else{tickArray=scaleCalc.ticks(axisTicks.size());tickSpacing=scaleCalc(tickArray[tickArray.length-1])-scaleCalc(tickArray[tickArray.length-2])}return tickSpacing}function rtlTextAnchor(anchor){if(direction==="rtl"){if(anchor==="start"){return"end"}else if(anchor==="end"){return"start"}}return anchor}function isMirrored(){return axis.orient()!=="left"&&axis.orient()!=="bottom"}function setThickness(s){s=s||1;thickness=axis.tickPadding()+(vertical?maxLabelWidth:maxLabelHeight)*s}function calcMaxLabelSizes(){calcTickLabelSizes();maxLabelWidth=d3.max(tickDimensions,function(d){return d.width});maxLabelHeight=d3.max(tickDimensions,function(d){return d.height})}function calcTickLabelSizes(){tickDimensions=[];tickDimensionsHash={};if(showMaxMin){axisMaxMin.style("opacity",1).attr("transform",function(d,i){var trans=vertical?"0,"+scaleCalc(d):scaleCalc(d)+",0";return"translate("+trans+")"})}tickText.each(function(d,i){var bbox=this.getBoundingClientRect();if(bbox.width>0){tickDimensions.push({key:d,width:parseInt(bbox.width,10),height:parseInt(bbox.height/1.2,10),left:bbox.left,right:bbox.right,top:bbox.top,bottom:bbox.bottom})}});tickDimensions.sort(function(a,b){return a.key-b.key}).forEach(function(d,i){d.index=i;tickDimensionsHash["key-"+d.key.toString()]=d});minTickDimensions=tickDimensions[0];maxTickDimensions=tickDimensions[tickDimensions.length-1]}function labelCollision(s){calcTickLabelSizes();var skip=showMaxMin?2:s||1;for(var i=showMaxMin?1:0,l=tickDimensions.length-skip;i<l;i+=1){if(tickDimensions[i].right+tickGap>tickDimensions[i+s].left){return true}}return false}function recalcMargin(a){var normRotation=a?(a+180)%180:0,isRotatedLeft=normRotation>90,dMin=null,dMax=null;tickDimensions.forEach(function(d,i){var isMin=dMin===null||d.left<=dMin,isMax=dMax===null||d.right>=dMax,textWidth=0,tickPosition=0,availableSpace=0;if(!isMin&&!isMax){return}textWidth=normRotation?d.width-6:d.width/2;tickPosition=scaleCalc(d.key)+hasRangeBand*getBarWidth()/2;if(isMin&&(!normRotation||isRotatedLeft)){dMin=d.left;availableSpace=Math.abs(extent[0]-tickPosition);marginCalc.left=Math.max(textWidth-availableSpace,0)}if(isMax&&(!normRotation||!isRotatedLeft)){dMax=d.right;availableSpace=Math.abs(extent[1]-tickPosition);marginCalc.right=Math.max(textWidth-availableSpace,0)}});if(!hasRangeBand){var change=margin.right-Math.max(margin.right,marginCalc.right);change+=margin.left-Math.max(margin.left,marginCalc.left);var newExtent=[extent[0],extent[1]+change];scaleCalc.range(newExtent);extent=getRangeExtent();scaleWidth=Math.abs(extent[1]-extent[0]);axis.scale(scaleCalc);g.call(axis)}}function resetTicks(){marginCalc={top:0,right:0,bottom:0,left:0};scaleCalc=scale.copy();extent=getRangeExtent();scaleWidth=Math.abs(extent[1]-extent[0]);axis.scale(scale);g.call(axis);tickText.selectAll("tspan").remove();tickText.attr("dy",vertical?".32em":.355+.355*reflect+"em").attr("x",vertical?axis.tickPadding()*reflect:0).attr("y",vertical?0:axis.tickPadding()*reflect).attr("transform","translate(0,0)").text(function(d,i){return tickValueArray[i]}).style("text-anchor","middle").style("opacity",1);calcMaxLabelSizes();setThickness()}function handleWrap(){tickSpacing=getTickSpacing();tickText.each(function(d,i){var textContent=fmt(d,i,true),textNode=d3.select(this),textArray=textContent&&textContent!==""?textContent.replace("/","/ ").split(" "):[],i=0,l=textArray.length,dy=reflect===1?.71:-1;this.textContent="";var textString,textSpan=textNode.append("tspan").text(textArray[i]+" ").attr("dy",dy+"em").attr("x",0);i+=1;dy=1;while(i<l){textSpan=textNode.append("tspan").text(textArray[i]+" ").attr("dy",dy+"em").attr("x",0);i+=1;while(i<l){textString=textSpan.text();textSpan.text(textString+" "+textArray[i]);if(this.getBoundingClientRect().width<=tickSpacing){i+=1}else{textSpan.text(textString);break}}}});calcMaxLabelSizes();setThickness()}function handleStagger(){tickText.attr("transform",function(d,i){var yOffset=tickDimensionsHash["key-"+d.toString()].index%2*(maxLabelHeight+2);return"translate(0,"+yOffset+")"});calcMaxLabelSizes();setThickness(2)}function handleRotation(a){var normRotation=(a+180)%180,isLeft=normRotation>90,angle=(normRotation-(isLeft?180:0))*reflect,tickAnchor=rtlTextAnchor(isLeft?"end":"start"),cos=Math.abs(Math.cos(a*Math.PI/180));tickText.attr("transform",function(d,i,j){return"translate(0,"+axis.tickPadding()*reflect+") rotate("+angle+")"}).attr("y","0").style("text-anchor",tickAnchor);calcMaxLabelSizes();setThickness();thickness+=cos*11}chart.resizeTickLines=function(dim){g.selectAll("g.tick, g.sc-axisMaxMin").select("line").attr(vertical?"x2":"y2",dim*reflect)};chart.labelThickness=function(){return labelThickness}});return chart}chart.axis=axis;d3.rebind(chart,axis,"orient","tickValues","tickSubdivide","tickSize","tickPadding","tickFormat");d3.rebind(chart,scale,"domain","range","rangeBand","rangeBands");
chart.width=function(_){if(!arguments.length){return thickness}return chart};chart.height=function(_){if(!arguments.length){return thickness}return chart};chart.margin=function(_){if(!arguments.length){return margin}margin=_;return chart};chart.ticks=function(_){if(!arguments.length){return ticks}ticks=_;return chart};chart.axisLabel=function(_){if(!arguments.length){return axisLabelText}axisLabelText=_;return chart};chart.showMaxMin=function(_){if(!arguments.length){return showMaxMin}showMaxMin=_;return chart};chart.highlightZero=function(_){if(!arguments.length){return highlightZero}highlightZero=_;return chart};chart.scale=function(_){if(!arguments.length){return scale}scale=_;axis.scale(scale);hasRange